openapi: 3.0.0
info:
  title: Orders API
  description: API de gestión de pedidos, inventario y productos.
  version: 1.0.0
servers:
  - url: http://localhost:3002
    description: Servidor Local

paths:
  /health:
    get:
      summary: Health Check
      responses:
        '200':
          description: Servicio operativo

  # =======================
  # PRODUCTOS
  # =======================
  /products:
    get:
      summary: Listar y buscar productos
      parameters:
        - in: query
          name: search
          schema: { type: string }
          description: Nombre o SKU
        - in: query
          name: cursor
          schema: { type: integer }
        - in: query
          name: limit
          schema: { type: integer, default: 10 }
      responses:
        '200':
          description: Lista de productos con paginación

    post:
      summary: Crear producto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sku, name, price_cents, stock]
              properties:
                sku: { type: string }
                name: { type: string }
                price_cents: { type: integer, description: "Precio en centavos" }
                stock: { type: integer }
      responses:
        '201':
          description: Producto creado

  /products/{id}:
    get:
      summary: Detalle de producto
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Detalle del producto
        '404':
          description: No encontrado

    patch:
      summary: Actualizar stock o precio
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                price_cents: { type: integer }
                stock: { type: integer }
                name: { type: string }
      responses:
        '200':
          description: Producto actualizado

  # =======================
  # ÓRDENES
  # =======================
  /orders:
    get:
      summary: Listar pedidos con filtros
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [CREATED, CONFIRMED, CANCELED]
        - in: query
          name: from
          schema: { type: string, format: date }
          description: Fecha inicial (YYYY-MM-DD)
        - in: query
          name: to
          schema: { type: string, format: date }
          description: Fecha final (YYYY-MM-DD)
        - in: query
          name: cursor
          schema: { type: integer }
        - in: query
          name: limit
          schema: { type: integer, default: 10 }
      responses:
        '200':
          description: Historial de órdenes paginado

    post:
      summary: Crear pedido (Transacción ACID)
      description: Valida cliente, verifica stock, crea orden en estado CREATED y descuenta inventario.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [customer_id, items]
              properties:
                customer_id: { type: integer }
                items:
                  type: array
                  items:
                    type: object
                    required: [product_id, qty]
                    properties:
                      product_id: { type: integer }
                      qty: { type: integer }
      responses:
        '201':
          description: Orden creada
        '400':
          description: Stock insuficiente o datos inválidos
        '404':
          description: Cliente no existe

  /orders/{id}:
    get:
      summary: Obtener orden completa (con items)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Detalle de la orden incluyendo lista de productos

  /orders/{id}/confirm:
    post:
      summary: Confirmar pedido (Idempotente)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: header
          name: X-Idempotency-Key
          required: false
          schema: { type: string }
          description: Clave única para evitar duplicados
      responses:
        '200':
          description: Orden confirmada (CONFIRMED)
        '409':
          description: Conflicto de idempotencia

  /orders/{id}/cancel:
    post:
      summary: Cancelar pedido
      description: Cancela la orden y restaura el stock. Si está CONFIRMED, solo permite cancelar si pasaron menos de 10 min.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Orden cancelada y stock restaurado
        '409':
          description: No se puede cancelar (Regla de negocio de 10 min)